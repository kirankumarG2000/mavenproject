version: 0.2
phases:
  install:
    runtime-versions:
      docker: 19
  pre_build:
    commands:
    - echo Logging in to Amazon ECR...
    - aws --version
    - aws ecr get-login-password | docker login --username AWS --password-stdin 222512976514.dkr.ecr.ap-southeast-1.amazonaws.com
  build:
    commands:
    - echo Build started on `date`
    - echo Building Java
    - cd pharmacymedicalsupply
    - mvn compile
    - mvn package -DskipTests
    - docker --version
    - echo Building the docker image..
    - docker build -t pharmacymedicalsupply .
    - echo Checking docker image pharmacymedicalsupply
    - docker images --filter reference=pharmacymedicalsupply
    - docker tag pharmacymedicalsupply 222512976514.dkr.ecr.ap-southeast-1.amazonaws.com/pmsms-ecr-repo:pharmacymedicalsupply
    - echo Checking tag added before the docker image
    - docker images
  post_build:
    commands:
    - echo Build completed on `date`
    - echo Pushing docker image
    - docker push 222512976514.dkr.ecr.ap-southeast-1.amazonaws.com/pmsms-ecr-repo
    - echo Writting definition file
    - printf '[{"name":"pmsms-pharmacymedicalsupply","imageUri":"%s"}]' 222512976514.dkr.ecr.ap-southeast-1.amazonaws.com/pmsms-ecr-repo:pharmacymedicalsupply > imagedefinitions.json
artifacts:
  files:
  - pharmacymedicalsupply/imagedefinitions.json